#!/usr/bin/env torch-qlua

_kernel_ = true

require 'torch'
require 'nn'
require 'torch-env'

import 'torch'
import 'image'
import 'gnuplot'
import ('webterm',true)
import 'paths'
import 'fs'

print '[kernel started]'

_G.reset = function()
   os.exit()
end

_G.complete = function(input)
   local m = nil
   local delims = {'%[','%]','%{','%}','%(','%)',',','=',''}
   for _,delim in ipairs(delims) do
      local nm = input:gfind(delim..'(.-)$')()
      m = m or nm
      if nm and #nm < #m then
         m = nm
      end
   end
   if not m or m == '' then
      return
   end
   m = m:gfind('%s*(.*)%s*')()
   local namespaces = {}
   local symbol = m
   local tbl = _G
   local namespace = ''
   while true do
      namespace = m:gfind('(.-)%.')()
      if not namespace then break end
      if type(tbl) ~= 'table' then return end
      tbl = tbl[namespace]
      table.insert(namespaces, namespace)
      m = m:gfind('.-%.(.*)')()
      if not m or m == '' then break end
   end
   namespace = namespaces[#namespaces] or ''
   if type(tbl) == 'table' then
      local s = ''
      for k in pairs(tbl) do
         if namespace ~= '' then
            k = namespace .. '.' .. k
         end
         if k:find('^'..symbol) then
            s = s .. '<a target="_blank" href="http://www.torch.ch/?do=search&id='.. k .. '">'
                  .. k .. '</a><br />'
         end
      end
      io.write('<script>$(\'.completion\').html(\''..s..'\');</script>')
   end
end

local function traceback (message)
   local tp = type(message)
   if tp ~= "string" and tp ~= "number" then return message end
   local debug = _G.debug
   if type(debug) ~= "table" then return message end
   local tb = debug.traceback
   if type(tb) ~= "function" then return message end
   return tb(message, 2)
end

local iowrite = io.write
io.write = function(w)
   iowrite(w)
   io.flush()
end

while true do
   io.flush()
   local line = io.read('*line')
   if line then
      if line:find('^=') then
         line = 'print(' .. line:gsub('^=','') .. ')'
      elseif line:find('^?') then
         line = 'help(' .. line:gsub('^?','') .. ')'
      end
      local ok,err = pcall(loadstring(line))
      if not ok then
         if err == 'attempt to call a nil value' then
            local ok,err = xpcall(loadstring('print(' .. line .. ')'), traceback)
            if not ok then
               print(err)
            end
         else
            print(err)
         end
      end
   end
end
